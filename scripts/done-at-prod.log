-- vim: fdm=marker et ts=2 sw=2 list

{{{1 Changed author of ...kajs-sida  @ www.debiki.se

But shouldn't be done in this manner!!! Should add a new PageAction.

select * from dw1_page_actions where paid = 'q98404j8dr';
kaj   login  544

Kajs sida:
select * from dw1_pages where guid = '14pg60hulm';
 sno | tenant |    guid    
-----+--------+------------
 198 | 2      | 14pg60hulm


> select * from dw1_page_actions where paid = '1' and page = '198';
 page | paid | login |          time          | type | relpa |                             text                              | markup | wheere | new_ip 
------+------+-------+------------------------+------+-------+---------------------------------------------------------------+--------+--------+--------
 198  | 1    | 536   | 2012-03-11 09:19:54.43 | Post | 1     | Title                                                        +| dmd0   |        | 
      |      |       |                        |      |       | ============                                                 +|        |        | 
      |      |       |                        |      |       |                                                              +|        |        | 
 ...
(1 row)


> select * from dw1_logins where sno = '544';
 sno | tenant | prev_login | id_type | id_sno | login_ip |       login_time        | logout_ip | logout_time 
-----+--------+------------+---------+--------+----------+-------------------------+-----------+-------------
 544 | 2      |            | Simple  | 297    | ?.?.?.?  | 2012-03-19 16:40:55.003 |           | 

> select * from dw1_ids_simple where sno = '297';
 sno |     name     |         email          | location | website 
-----+--------------+------------------------+----------+---------
 297 | Kaj Lindberg | kaj.lindberg@telia.com | -        | -
(1 row)

\SET AUTOCOMMIT OFF
update dw1_page_actions set login = 544 where paid = '1' and page = '198';
COMMIT


}}}1
-- {{{ 2011-04-16  Splits DW1_PAGE_ACTIONS.PAGE into TENANT and PAGE_ID:
------------------------------------------

---
alter table DW1_PAGE_ACTIONS add TENANT varchar(32);

alter table DW1_PAGE_ACTIONS add PAGE_ID varchar(32);

update DW1_PAGE_ACTIONS a set
  PAGE_ID = (select p.GUID from DW1_PAGES p where p.SNO = a.PAGE),
  TENANT = (select p.TENANT from DW1_PAGES p where p.SNO = a.PAGE);

alter table DW1_PAGE_ACTIONS alter column TENANT set not null;
alter table DW1_PAGE_ACTIONS alter column PAGE_ID set not null;

---
alter table DW1_PAGE_RATINGS add column TENANT varchar(32);
alter table DW1_PAGE_RATINGS add column PAGE_ID varchar(32);
--

update DW1_PAGE_RATINGS r set
   TENANT = (select a.TENANT from DW1_PAGE_ACTIONS a where a.PAGE = r.PAGE and a.PAID = r.PAID),
   PAGE_ID = (select a.PAGE_ID from DW1_PAGE_ACTIONS a where a.PAGE = r.PAGE and a.PAID = r.PAID);

select * from DW1_PAGE_RATINGS limit 200;

alter table DW1_PAGE_RATINGS drop constraint DW1_PRATINGS__P;
alter table DW1_PAGE_RATINGS drop constraint DW1_PRATINGS__R__PACTIONS;
alter table DW1_PAGE_RATINGS add constraint DW1_ARTS__P primary key (TENANT, PAGE_ID, PAID, TAG);

---
 alter table DW1_PAGE_ACTIONS drop constraint DW1_PACTIONS__R__PACTIONS;
 alter table DW1_PAGE_ACTIONS drop constraint DW1_PACTIONS_PAGE_PAID__P;
 alter table DW1_PAGE_ACTIONS add constraint DW1_PGAS_TNT_PGID_ID__P
   primary key (TENANT, PAGE_ID, PAID);
 alter table DW1_PAGE_ACTIONS add constraint DW1_PGAS__R__PGAS
    foreign key (TENANT, PAGE_ID, RELPA) -- no ix: no dels/upds in prnt tbl
                       -- and no joins (loading whole page at once instead)
    references DW1_PAGE_ACTIONS (TENANT, PAGE_ID, PAID) deferrable;
 alter table DW1_PAGE_ACTIONS add constraint DW1_PGAS_TNT_PGID__R__PGPTHS
  foreign key (TENANT, PAGE_ID)
  references DW1_PAGE_PATHS (TENANT, PAGE_ID) deferrable;

---
alter table DW1_PAGE_RATINGS add
  constraint DW1_ARTS__R__PGAS  -- ix primary key
      foreign key (TENANT, PAGE_ID, PAID)
      references DW1_PAGE_ACTIONS(TENANT, PAGE_ID, PAID) deferrable;

alter table DW1_PAGE_RATINGS alter column TENANT set not null;
alter table DW1_PAGE_RATINGS alter column PAGE_ID set not null;

---
alter table DW1_PAGE_ACTIONS alter column PAGE drop not null;
alter table DW1_PAGE_RATINGS alter column PAGE drop not null;

-------------------------------------
------------ done above, @dev, @test, @prod.
-- }}}
{{{1 2011-04-23 Copy email & name to user table

-- done @prod, @dev, skip test:

\set AUTOCOMMIT off
select * from dw1_users;
select tenant, sno, usr, first_name, email from dw1_ids_openid ;
update DW1_USERS u set DISPLAY_NAME = i.FIRST_NAME, EMAIL = i.EMAIL
  from DW1_IDS_OPENID i
  where u.TENANT = i.TENANT and u.SNO = i.USR;
select * from dw1_users;
select oid_realm, tenant, sno, usr, first_name, email from dw1_ids_openid ;
commit;

Result: (DW1_USERS email and display_name were all null before)

debiki_prod=> select * from dw1_users;
 tenant | sno | display_name |         email          | country | website | superadmin | email_notfs 
--------+-----+--------------+------------------------+---------+---------+------------+-------------
 2      | 51  |              |                        |         |         | T          | R
 2      | 10  | Magnus       | leomaheo@gmail.com     |         |         | T          | 
 2      | 30  | KajMagnus    | kajmagnus79d@gmail.com |         |         | T          | N
 2      | 52  | Kaj Magnus   | kajmagnus79@gmail.com  |         |         |            | 
 12     | 53  | KajMagnus    | kajmagnus79d@gmail.com |         |         |            | 
 12     | 54  | KajMagnus    | kajmagnus79d@gmail.com |         |         | T          | 
 3      | 56  | KajMagnus    | kajmagnus79d@gmail.com |         |         |            | 
 3      | 55  | KajMagnus    | kajmagnus79d@gmail.com |         |         | T          | N
(8 rows)

debiki_prod=> select oid_realm, tenant, sno, usr, first_name, email from dw1_ids_openid ;
         oid_realm          | tenant | sno | usr | first_name |         email          
----------------------------+--------+-----+-----+------------+------------------------
 http://*.debiki.se         | 2      | 10  | 10  | Magnus     | leomaheo@gmail.com
 http://kajmagnus.debiki.se | 12     | 331 | 53  | KajMagnus  | kajmagnus79d@gmail.com
 http://localhost:8080      | 2      | 289 | 52  | Kaj Magnus | kajmagnus79@gmail.com
 http://localhost:8080      | 2      | 273 | 30  | KajMagnus  | kajmagnus79d@gmail.com
 http://*.debiki.se         | 2      | 230 | 30  | KajMagnus  | kajmagnus79d@gmail.com
 http://*.debiki.se         | 12     | 332 | 54  | KajMagnus  | kajmagnus79d@gmail.com
 http://localhost:9003      | 3      | 345 | 56  | KajMagnus  | kajmagnus79d@gmail.com
 http://*.debiki.com        | 3      | 344 | 55  | KajMagnus  | kajmagnus79d@gmail.com
(8 rows)

debiki_prod=> commit;
COMMIT

}}}1

